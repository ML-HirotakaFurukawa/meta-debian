From 194cacd1d85839a294c094f26aa66e70b1d0cb31 Mon Sep 17 00:00:00 2001
From: Takahiro Terada <takahiro.terada@miraclelinux.com>
Date: Thu, 15 Feb 2024 18:57:53 +0900
Subject: [PATCH] Fix yacc output files conflict

When parallel building with "--with-devel=yes" in configure, may cause build
errors because of conflicts files regenerated by the yacc command.

In detail, the files generated from gram.y and getdate.y in plugins/sudoers/ by
yacc are the same name "y.tab.c".

So add "-b prefix" to the yacc command parameter for avoid files conflicts.
This "prefix" is filename of make target.

And, modifed that editing is done on temporary "prefix.tmp.c" file.
Because, the contents of the ".c" file and the "prologue" file may the same in
case of bad timing on parallel builds.

Signed-off-by: Takahiro Terada <takahiro.terada@miraclelinux.com>
---
 plugins/sudoers/Makefile.in | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/plugins/sudoers/Makefile.in b/plugins/sudoers/Makefile.in
index e3f6bb5..ebcb5c4 100644
--- a/plugins/sudoers/Makefile.in
+++ b/plugins/sudoers/Makefile.in
@@ -344,7 +344,8 @@ $(devdir)/gram.c $(devdir)/gram.h: $(srcdir)/gram.y prologue
 	    else \
 		gram_y="$(srcdir)/gram.y"; \
 	    fi; \
-	    cmd='$(YACC) -d -p sudoers '"$$gram_y"'; cp prologue $(devdir)/gram.c; $(SED) "s/^\\(#line .*\\) \"y\\.tab\\.c\"/\1 \"gram.c\"/" y.tab.c >> $(devdir)/gram.c; rm -f y.tab.c; mv -f y.tab.h $(devdir)/gram.h'; \
+	    prefix='$@'; \
+	    cmd='$(YACC) -d -p sudoers '"-b $$prefix $$gram_y"'; cp prologue $(devdir)/'"$$prefix"'.tmp.c; $(SED) "s/^\\(#line .*\\) \"'"$$prefix"'\\.tab\\.c\"/\1 \"'"$$prefix"'.tmp.c\"/" '"$$prefix"'.tab.c >> $(devdir)/'"$$prefix"'.tmp.c; rm -f '"$$prefix"'.tab.c; mv -f $(devdir)/'"$$prefix"'.tmp.c $(devdir)/gram.c; mv -f '"$$prefix"'.tab.h $(devdir)/gram.h'; \
 	    echo "$$cmd"; eval $$cmd; \
 	fi
 
@@ -367,7 +368,8 @@ $(devdir)/getdate.c: $(srcdir)/getdate.y prologue
 	    else \
 		getdate_y="$(srcdir)/getdate.y"; \
 	    fi; \
-	    cmd='$(YACC) '"$$getdate_y"'; cp prologue $(devdir)/getdate.c; $(SED) "s/^\\(#line .*\\) \"y\\.tab\\.c\"/\1 \"getdate.c\"/" y.tab.c >> $(devdir)/getdate.c; rm -f y.tab.c'; \
+	    prefix='$@'; \
+	    cmd='$(YACC) '"-b $$prefix $$getdate_y"'; cp prologue $(devdir)/'"$$prefix"'.tmp.c; $(SED) "s/^\\(#line .*\\) \"'"$$prefix"'\\.tab\\.c\"/\1 \"'"$$prefix"'.tmp.c\"/" '"$$prefix"'.tab.c >> $(devdir)/'"$$prefix"'.tmp.c; mv -f $(devdir)/'"$$prefix"'.tmp.c $(devdir)/getdate.c; rm -f '"$$prefix"'.tab.c'; \
 	    echo "$$cmd"; eval $$cmd; \
 	fi
 
-- 
2.25.1

